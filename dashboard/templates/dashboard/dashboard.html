{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard Monitoring{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  integrity="sha512-8N4+aWnms0ZqU3SbdVQ2pEoPEt0kXUS6T2qBlWWdUBxYfFdFaYxC6mGmXK7sCVG7mAJGcK1wz5P8lYz8v3Bvw=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>
{% endblock %}

{% block content %}
<section class="dashboard-container">
    <h1>Dashboard Monitoring</h1>

    <p>
        Selamat datang kembali, 
        {% if request.user.petani_profile %}
            {{ request.user.petani_profile.nama_lengkap|default:request.user.username }}
        {% else %}
            {{ request.user.first_name|default:request.user.username }}
        {% endif %}!
        Berikut ringkasan kondisi tanaman Anda hari ini.
    </p>

    <!-- STAT CARDS -->
    <div class="stats">

        <!-- STATUS TANAMAN -->
        <div class="card card-green">
            <h2 id="statusTanaman">-</h2>
            <p>Status Tanaman</p>
        </div>

        <!-- KONDISI LINGKUNGAN -->
        <div class="card card-yellow">
            <h2 id="kondisiLingkungan">-</h2>
            <p>Kondisi Lingkungan</p>
        </div>

        <!-- STATUS SENSOR -->
        <div class="card card-blue">
            <h2 id="statusSensor">-</h2>
            <p>Status Sensor</p>
        </div>

    </div>


    <!-- ALERT -->
    <div id="alertBox" class="alert" style="display: none;" onclick="scrollToSensor()">
        <div style="display: flex; align-items: center; gap: 15px;">
            <i id="alertIcon" class="fa-solid fa-triangle-exclamation" style="font-size: 24px; color: #e74c3c;"></i>
            <div style="flex: 1;">
                <strong id="alertTitle" style="color: #721c24; font-size: 16px;">‚ö†Ô∏è Peringatan Kondisi Tidak Normal!</strong>
                <p id="alertMessage" style="margin: 5px 0 0 0; color: #721c24; font-size: 14px;">Loading...</p>
            </div>
            <i class="fa-solid fa-chevron-down" style="font-size: 18px; color: #721c24; animation: bounce 2s infinite;"></i>
        </div>
    </div>

    <!-- CHART -->
    <div class="chart-box">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 class="chart-title">
                <i class="fa-solid fa-chart-simple" style="color:#2c3e50;"></i> Data Sensor Real-Time
            </h3>
            
            <!-- TIME RANGE SELECTOR -->
            <div style="display: flex; gap: 10px; align-items: center;">
                <label style="font-size: 14px; color: #666;">Tampilkan:</label>
                <select id="timeRange" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; cursor: pointer;">
                    <option value="30">30 Menit Terakhir</option>
                    <option value="60" selected>1 Jam Terakhir</option>
                    <option value="180">3 Jam Terakhir</option>
                    <option value="360">6 Jam Terakhir</option>
                    <option value="720">12 Jam Terakhir</option>
                    <option value="1440">24 Jam Terakhir</option>
                </select>
                
                <button id="refreshChart" style="padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: transform 0.5s ease;">
                    <i class="fa-solid fa-rotate"></i> Refresh
                </button>
            </div>
        </div>
        
        <!-- Status Indicator -->
        <div id="chartStatus" style="font-size: 12px; color: #666; margin-bottom: 10px;">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Memuat data...
        </div>
        
        <canvas id="sensorChart"></canvas>
    </div>

    <!-- SENSOR DATA -->
    <div class="sensor-box" id="sensorBox">
        <h4 class="sensor-title">
            <i class="fa-solid fa-calendar-day" style="color:#2c3e50;"></i> Data Sensor Terbaru
        </h4>
        <p id="lastUpdate" style="margin-bottom: 15px; color: #666;">Update terakhir: Loading...</p>
        
        <!-- Status Badge -->
        <div id="statusBadge" style="display: inline-block; padding: 8px 15px; border-radius: 20px; margin-bottom: 15px; font-size: 13px; font-weight: 600;">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Memeriksa status...
        </div>
        
        <div class="sensor-stats">
            <div class="sensor-item">
                <span class="sensor-label">
                    <i class="fa-solid fa-temperature-three-quarters" style="color:#e74c3c;"></i> Suhu:
                </span>
                <span class="sensor-value" id="currentTemp">-¬∞C</span>
            </div>
            <div class="sensor-item">
                <span class="sensor-label">
                    <i class="fa-solid fa-droplet" style="color:#3498db;"></i> Kelembapan:
                </span>
                <span class="sensor-value" id="currentHumidity">-%</span>
            </div>
             <div class="sensor-item">
                <span class="sensor-label">
                    <i class="fa-solid fa-seedling" style="color:#27ae60;"></i> Kelembapan Tanah:
                </span>
                <span class="sensor-value" id="currentSoil">-%</span>
            </div>
        </div>
        
        <!-- Button Segera Deteksi -->
        <button class="btn-warning" onclick="window.location.href='{% url 'dashboard:deteksi' %}'" style="width: 100%; padding: 12px; font-size: 15px;">
            <i class="fa-solid fa-search"></i> Segera Deteksi Daun Sekarang
        </button>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
/* ===========================================
   CONFIG
=========================================== */
const API_BASE = window.location.origin + '/dashboard';
let UPDATE_INTERVAL = 30000;
let updateTimer = null;
let currentTimeRange = 60;

/* ===========================================
   SCROLL TO SENSOR
=========================================== */
function scrollToSensor() {
    const el = document.getElementById('sensorBox');
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    el.classList.add('highlight');
    setTimeout(() => el.classList.remove('highlight'), 2000);
}

/* ===========================================
   STATUS LOGIC (MONITORING MURNI)
=========================================== */
function getStatusTanaman(soil) {
    if (soil < 35)
        return { level: 'critical',text: 'Kritis (Terlalu Kering)', color: '#e74c3c' };

    if (soil > 90)
        return { level: 'critical', text: 'Kritis (Terlalu Basah)', color: '#3498db' };

    if (soil < 45 || soil > 80)
        return { text: 'Perlu Perhatian', color: '#f39c12' };

    return { text: 'Normal', color: '#27ae60' };
}

function getKondisiLingkungan(temp, hum) {
    if (temp < 18 || temp > 35 || hum < 50 || hum > 85)
        return { text: 'Ekstrem', color: '#e74c3c' };
    if (temp < 22 || temp > 32 || hum < 60 || hum > 80)
        return { text: 'Kurang Optimal', color: '#f39c12' };
    return { text: 'Optimal', color: '#27ae60' };
}

function getStatusSensor(timestamp) {
    const diffMin = (new Date() - new Date(timestamp)) / 60000;
    if (diffMin <= 5) return { text: 'Aktif', color: '#27ae60' };
    if (diffMin <= 30) return { text: 'Data Tidak Terbaru', color: '#f39c12' };
    return { text: 'Tidak Aktif', color: '#e74c3c' };
}

/* ===========================================
   INITIALIZE CHART
=========================================== */
const ctx = document.getElementById('sensorChart').getContext('2d');

const sensorChart = new Chart(ctx, {
    type: 'line', 
    data: { 
        labels: [], 
        datasets: [
            {
                label: 'Suhu (¬∞C)', 
                data: [], 
                borderColor: '#e74c3c', 
                backgroundColor: 'rgba(231, 76, 60, 0.1)', 
                borderWidth: 2, 
                tension: 0.4, 
                fill: true, 
                pointRadius: 2, 
                pointHoverRadius: 4
            },
            {
                label: 'Kelembapan (%)', 
                data: [], 
                borderColor: '#3498db', 
                backgroundColor: 'rgba(52, 152, 219, 0.1)', 
                borderWidth: 2, 
                tension: 0.4, 
                fill: true, 
                pointRadius: 2, 
                pointHoverRadius: 4
            },
            {
                label: 'Kelembapan Tanah (%)', 
                data: [], 
                borderColor: '#27ae60', 
                backgroundColor: 'rgba(39, 174, 96, 0.1)', 
                borderWidth: 2, 
                tension: 0.4, 
                fill: true, 
                pointRadius: 2, 
                pointHoverRadius: 4
            }
        ]
    },
   options: {
     responsive: true, 
     maintainAspectRatio: true, 
     aspectRatio: 2.5, 
     animation: { duration: 750 
     },
     plugins: {
         legend: {
             display: true, 
             position: 'top', 
             labels: {
                usePointStyle: true, 
                padding: 15, 
                font: {
                    size: 13, 
                    family: "'Poppins', sans-serif", 
                    weight: '500'
                }
            }
        },
        tooltip: {
             mode: 'index', 
             intersect: false, 
             backgroundColor: 'rgba(0, 0, 0, 0.8)', 
             padding: 12, 
             titleFont: {
                 size: 14, 
                 family: "'Poppins', sans-serif", 
                 weight: '600'
                }, 
                bodyFont: {
                    size: 13, 
                    family: "'Poppins', sans-serif" 
                }, 
                    borderColor: 'rgba(255, 255, 255, 0.2)', 
                    borderWidth: 1 
                }
            },
            scales: {
                 y: {
                    beginAtZero: false, 
                    suggestedMin: 20, 
                    suggestedMax: 85, 
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false 
                    }, 
                    ticks: {
                        font: {
                            family: "'Poppins', sans-serif", 
                            size: 12 
                        }, 
                        padding: 10, 
                        stepSize: 10 
                    }
                 },
                 x: {
                    grid: {
                        display: true, 
                        color: 'rgba(0, 0, 0, 0.05)' 
                    }, 
                    ticks: {
                        font: {
                            family: "'Poppins', sans-serif",
                            size: 11 
                        }, 
                        padding: 10, 
                        maxRotation: 0, 
                        autoSkip: true, 
                        autoSkipPadding: 50, 
                        maxTicksLimit: getMaxTicksLimit()
                    }
                 }
        }
    }
});

/* ===========================================
   FETCH LATEST SENSOR DATA
=========================================== */
async function fetchLatestData() {
    try {
        const res = await fetch(`${API_BASE}/api/sensor/latest/`);
        const json = await res.json();
        if (!json.success || !json.data) return;

        const d = json.data;
        const temp = +d.temperature;
        const hum  = +d.humidity;
        const soil = +d.soil_moisture;

        // Sensor values
        currentTemp.textContent = `${temp}¬∞C`;
        currentHumidity.textContent = `${hum}%`;
        currentSoil.textContent = soil !== null ? `${soil}%` : '‚Äî';

        // Status cards
        const st = getStatusTanaman(soil);
        const kl = getKondisiLingkungan(temp, hum);
        const ss = getStatusSensor(d.timestamp);

        statusTanaman.textContent = st.text;
        statusTanaman.style.color = st.color;

        kondisiLingkungan.textContent = kl.text;
        kondisiLingkungan.style.color = kl.color;

        statusSensor.textContent = ss.text;
        statusSensor.style.color = ss.color;

        // Status badge global
        if (st.text === 'Kritis' || kl.text === 'Ekstrem') {
            statusBadge.innerHTML = 'üö® Status: TIDAK NORMAL';
            statusBadge.style.background = '#e74c3c';
        } else if (st.text === 'Perlu Perhatian' || kl.text === 'Kurang Optimal') {
            statusBadge.innerHTML = '‚ö†Ô∏è Status: PERLU PERHATIAN';
            statusBadge.style.background = '#f39c12';
        } else if (st.text === 'Data Tidak Tersedia') {
            statusBadge.innerHTML = '‚ÑπÔ∏è Status: DATA TIDAK TERSEDIA';
            statusBadge.style.background = '#95a5a6';
        } else {
            statusBadge.innerHTML = '‚úÖ Status: NORMAL';
            statusBadge.style.background = '#27ae60';
        }
        statusBadge.style.color = '#fff';

        // Alert (TURUNAN STATUS)
       // ================================
       const diffMin = (new Date() - new Date(d.timestamp)) / 60000;

        // Jika data TIDAK fresh (> 5 menit)
        if (diffMin > 5) {
            alertBox.style.display = 'block';
            alertBox.classList.remove('blinking', 'alert-high');
            alertTitle.textContent = '‚ÑπÔ∏è Data Tidak Real-Time';
            alertMessage.textContent = `Data terakhir diterima ${Math.round(diffMin)} menit lalu. Sensor mungkin tidak aktif.`;
            alertIcon.className = 'fa-solid fa-clock';
            alertIcon.style.color = '#95a5a6';

        // Jika data fresh DAN tanaman kritis
        } else if (st.level === 'critical') {
            alertBox.style.display = 'block';
            alertBox.classList.add('blinking');
            alertBox.classList.remove('alert-high');
            alertTitle.textContent = 'üå± KONDISI TANAH KRITIS';
            alertMessage.textContent = `Kelembapan tanah ${soil}% berada di luar batas aman. Segera lakukan tindakan.`;
            alertIcon.className = 'fa-solid fa-seedling';
            alertIcon.style.color = '#c0392b';

        // Jika data fresh DAN lingkungan ekstrem
        } else if (kl.text === 'Ekstrem') {
            alertBox.style.display = 'block';
            alertBox.classList.add('blinking');
            alertBox.classList.remove('alert-high');
            alertTitle.textContent = 'üå°Ô∏è KONDISI LINGKUNGAN EKSTREM';
            alertMessage.textContent = `Suhu (${temp}¬∞C) atau kelembapan udara (${hum}%) tidak ideal untuk tanaman.`;
            alertIcon.className = 'fa-solid fa-temperature-high';
            alertIcon.style.color = '#e74c3c';

        // Jika semua normal
        } else {
            alertBox.style.display = 'none';
            alertBox.classList.remove('blinking', 'alert-high');
        }
        // Timestamp
        const t = new Date(d.timestamp).toLocaleString('id-ID', {
            day:'numeric', month:'short', year:'numeric',
            hour:'2-digit', minute:'2-digit'
        });
        lastUpdate.textContent = `Update terakhir: ${t} WIB`;

    } catch (e) {
        console.error('Latest data error:', e);
    }
}

/* ===========================================
   CHART
=========================================== */
function getMaxTicksLimit() {
    if (currentTimeRange <= 60) return 12;
    if (currentTimeRange <= 360) return 18;
    return 24;
}

// ===========================================
// FETCH CHART DATA
// ===========================================
async function fetchChartData() {
    try {
        chartStatus.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Memuat data...';

        const hours = currentTimeRange / 60;
        const res = await fetch(`${API_BASE}/api/sensor/chart/raw/?hours=${hours}`);
        const json = await res.json();

        if (!json.success || !json.data.length) {
            chartStatus.textContent = 'Belum ada data grafik.';
            return;
        }

        sensorChart.data.labels = json.data.map(d => d.time);
        sensorChart.data.datasets[0].data = json.data.map(d => d.temperature);
        sensorChart.data.datasets[1].data = json.data.map(d => d.humidity);
        sensorChart.data.datasets[2].data = json.data.map(d => d.soil_moisture);

        sensorChart.options.scales.x.ticks.maxTicksLimit = getMaxTicksLimit();
        sensorChart.update();

        chartStatus.innerHTML = `<i class="fa-solid fa-circle-check"></i> ${json.data.length} data dimuat`;

    } catch (e) {
        chartStatus.textContent = 'Gagal memuat grafik.';
        console.error(e);
    }
}

/* ===========================================
   UPDATE LOOP
=========================================== */
function updateDashboard() {
    fetchLatestData();
    fetchChartData();
}

function startAutoUpdate() {
    if (updateTimer) clearInterval(updateTimer);
    updateTimer = setInterval(updateDashboard, UPDATE_INTERVAL);
}

/* ===========================================
   EVENTS
=========================================== */
timeRange.addEventListener('change', e => {
    currentTimeRange = +e.target.value;
    updateDashboard();
});

refreshChart.addEventListener('click', () => {
    updateDashboard();
});

/* ===========================================
   INIT
=========================================== */
window.addEventListener('load', () => {
    updateDashboard();
    startAutoUpdate();
});
</script>
{% endblock %}