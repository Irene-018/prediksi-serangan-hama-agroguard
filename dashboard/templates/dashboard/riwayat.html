{% extends 'base.html' %}
{% load static %}

{% block title %}Riwayat Deteksi - AgroGuard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/riwayat.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&family=Roboto:wght@300;400;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="riwayat-section">
  <h1>Riwayat Deteksi</h1>
  <p class="subtitle">Histori lengkap deteksi dan treatment tanaman</p>

  <!-- Search dan Export -->
  <div class="search-export">
    <input type="text" id="searchInput" placeholder="Cari riwayat deteksi..." />
    <button class="export-btn">
      <a href="{% url 'dashboard:export_pdf' %}">
        <i class="fas fa-file-pdf"></i> Export PDF
      </a>
    </button>
  </div>

  <!-- Statistik Cards (dinamis dari database) -->
  <div class="stats-container">
    <div class="stat-card stat-green">
      <div class="stat-label">Total Deteksi</div>
      <div class="stat-value">{{ total_deteksi|default:"0" }}</div>
    </div>
    <div class="stat-card stat-red">
      <div class="stat-label">Tanaman Sakit</div>
      <div class="stat-value">{{ total_sakit|default:"0" }}</div>
    </div>
    <div class="stat-card stat-orange">
      <div class="stat-label">Perlu Penanganan</div>
      <div class="stat-value">{{ perlu_penanganan|default:"0" }}</div>
    </div>
  </div>

  <!-- Tabel Riwayat (dinamis dari RiwayatDeteksi) -->
  <div class="table-container">
    <table class="riwayat-table">
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Foto</th>
          <th>Tanaman</th>
          <th>Hasil Deteksi</th>
          <th>Confidence</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for r in riwayat_list %}
        <tr>
          <td>{{ r.created_at|date:"d M Y H:i" }}</td>
          <td>
            {% if r.hasil_deteksi.citra.path_file %}
              <div class="photo-box">
                <img src="{{ r.hasil_deteksi.citra.path_file.url }}" alt="Citra" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px;">
              </div>
            {% else %}
              <div class="photo-box"><i class="fas fa-image"></i></div>
            {% endif %}
          </td>
          <td>
            {% if r.lahan %}
              {{ r.lahan.jenis_tanaman }}
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            <div class="hasil">
              <span class="penyakit">{{ r.hasil_deteksi.jenis_hama.nama }}</span><br />
              <span class="tingkat">
                Tingkat :
                {% if r.hasil_deteksi.tingkat_serangan == 'ringan' %}Ringan
                {% elif r.hasil_deteksi.tingkat_serangan == 'sedang' %}Sedang
                {% elif r.hasil_deteksi.tingkat_serangan == 'berat' %}Berat
                {% else %}-{% endif %}
              </span>
            </div>
          </td>
          <td>{{ r.hasil_deteksi.confidence_score }}%</td>
          <td>
            {{ r.get_status_penanganan_display|default:r.status_penanganan }}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" style="text-align: center; padding: 40px; color: #9cb3a5; font-style: italic;">
            Belum ada riwayat deteksi
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.getElementById('searchInput').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('.riwayat-table tbody tr');
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
});

document.querySelector('.export-btn').addEventListener('click', () => {
  alert('Fitur Export PDF akan segera tersedia!');
});
</script>
{% endblock %}
